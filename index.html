<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>やましろやPay（社内テスト）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      background:#f2f2f2;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:16px;
    }

    .app{ width:380px; max-width:96vw; display:flex; flex-direction:column; gap:12px; }

    .box{
      background:#fff;
      border-radius:16px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }

    h1{ font-size:16px; margin:0 0 6px; }
    .desc{ font-size:12px; color:#666; margin:0 0 10px; }

    label{ font-size:12px; color:#666; font-weight:700; display:flex; flex-direction:column; gap:6px; }
    input{
      padding:12px;
      border-radius:12px;
      border:1px solid #ccc;
      font-size:16px;
    }

    .actions{ display:flex; gap:10px; margin-top:10px; }
    button{
      flex:1;
      padding:12px;
      border-radius:12px;
      border:0;
      font-weight:800;
      cursor:pointer;
    }
    .primary{ background:#111; color:#fff; }
    .ghost{ background:#eee; }

    .error{ color:#c62828; font-size:12px; font-weight:700; display:none; }

    /* ===== カード表示 ===== */
    .wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }

    .card-container{ perspective:1000px; }
    .card{
      width:340px; max-width:92vw;
      aspect-ratio:1.586/1;
      position:relative;
      transform-style:preserve-3d;
      transition:.6s;
      cursor:pointer;
    }
    .card.is-flipped{ transform:rotateY(180deg); }

    .face{
      position:absolute; inset:0;
      backface-visibility:hidden;
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 10px 25px rgba(0,0,0,.15);
      background-image:url("./frontback.png");
      background-size:100% 200%;
      background-repeat:no-repeat;
      background-color:#fff;
    }
    .front{ background-position:0% 0%; }
    .back{
      transform:rotateY(180deg);
      background-position:0% 100%;
      padding:12px;
      display:flex;
      justify-content:flex-end;
    }

    .barcode-box{
      width:100%;
      background: #ffffff;


      border-radius:12px;
      padding:10px;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }

    .cardno{
      font-weight:900;
      letter-spacing:.12em;
      font-size:13px;
      user-select:none;
    }

    .hint{ font-size:12px; color:#666; font-weight:700; }
    /* === Flip effect pack === */

/* カードの動きを少しリッチに */
.card{
  transition: transform .6s cubic-bezier(.2,.8,.2,1);
  will-change: transform;
}

/* 反転開始の「押した感」 */
.card.is-press{
  transform: translateZ(0) scale(0.985);
}

/* 影の変化（立体感） */
.face{
  transition: box-shadow .35s ease;
}

/* 反転中に影を少し強く */
.card.is-flipping .face{
  box-shadow: 0 16px 40px rgba(0,0,0,.20);
}

/* 光のスイープ（カード全体に走る） */
.card::after{
  content:"";
  position:absolute;
  inset:-30%;
  pointer-events:none;
  background: linear-gradient(120deg,
    rgba(255,255,255,0) 0%,
    rgba(255,255,255,.45) 45%,
    rgba(255,255,255,0) 70%
  );
  transform: translateX(-120%) rotate(0deg);
  opacity: 0;
  mix-blend-mode: screen;
}

/* スイープを走らせる */
.card.sweep::after{
  opacity: 1;
  animation: sweep 650ms cubic-bezier(.2,.8,.2,1) forwards;
}

@keyframes sweep{
  0%   { transform: translateX(-120%) rotate(0deg); opacity: 0; }
  10%  { opacity: 1; }
  100% { transform: translateX(120%) rotate(0deg); opacity: 0; }
}

/* バーコード枠も少し反応させる */
.card.sweep .barcode-box{
  animation: pop 220ms ease-out;
}

@keyframes pop{
  0%   { transform: scale(1); }
  50%  { transform: scale(1.015); }
  100% { transform: scale(1); }
}

/* 低減設定に配慮（iOSの“視差効果を減らす”等） */
@media (prefers-reduced-motion: reduce){
  .card, .face{ transition: none; }
  .card::after{ display:none; }
  .card.sweep .barcode-box{ animation:none; }
}
/* =====派手版：キラキラ&フラッシュ===== */

/* 反転時のホワイトフラッシュ */
.card::before{
  content:"";
  position:absolute;
  inset:-20%;
  pointer-events:none;
  background: radial-gradient(circle at 30% 30%,
    rgba(255,255,255,.65) 0%,
    rgba(255,255,255,0) 55%);
  opacity:0;
  transform: scale(.9);
  filter: blur(2px);
}
.card.flash::before{
  animation: flash 380ms ease-out forwards;
}
@keyframes flash{
  0%   { opacity:0; transform:scale(.9); }
  30%  { opacity:.9; transform:scale(1.05); }
  100% { opacity:0; transform:scale(1.15); }
}

/* キラ粒：CSSだけで “散る” 表現（軽量） */
.card .sparkles{
  position:absolute;
  inset:-10%;
  pointer-events:none;
  opacity:0;
}

.card.sparkle .sparkles{
  opacity:1;
  animation: sparkleFade 650ms ease-out forwards;
}
@keyframes sparkleFade{
  0%   { opacity:0; }
  15%  { opacity:1; }
  100% { opacity:0; }
}

/* 粒（12個）を疑似的に作る */
.card .sparkles i{
  position:absolute;
  width:6px; height:6px;
  border-radius:999px;
  background: rgba(255,255,255,.95);
  box-shadow:
    0 0 10px rgba(255,255,255,.9),
    0 0 18px rgba(255,255,255,.6);
  transform: translate(-50%,-50%) scale(.7);
  opacity:.95;
  filter: blur(.1px);
}

/* それぞれ飛ぶ方向と時間をズラす */
.card.sparkle .sparkles i{
  animation: burst 650ms cubic-bezier(.2,.8,.2,1) forwards;
}

@keyframes burst{
  0%   { transform: translate(var(--x0), var(--y0)) scale(.6); opacity:0; }
  15%  { opacity:1; }
  100% { transform: translate(var(--x1), var(--y1)) scale(0); opacity:0; }
}

/* =====バーコード：出現時に “発光” ===== */
.barcode-box{
  position:relative;
  overflow:hidden;
}

.barcode-box.glow{
  animation: barcodeGlow 520ms ease-out forwards;
  box-shadow: 0 0 0 rgba(255,255,255,0); /* 初期 */
}

@keyframes barcodeGlow{
  0%   { box-shadow: 0 0 0 rgba(255,255,255,0); transform: scale(1); }
  30%  { box-shadow: 0 0 22px rgba(255,255,255,.95), 0 0 45px rgba(255,255,255,.55); transform: scale(1.01); }
  100% { box-shadow: 0 0 0 rgba(255,255,255,0); transform: scale(1); }
}

/* バーコードに光が走る（スキャン感） */
.barcode-box::after{
  content:"";
  position:absolute;
  top:-40%;
  left:-60%;
  width:60%;
  height:180%;
  background: linear-gradient(120deg,
    rgba(255,255,255,0) 0%,
    rgba(255,255,255,.55) 45%,
    rgba(255,255,255,0) 70%);
  transform: rotate(12deg) translateX(0);
  opacity:0;
  pointer-events:none;
  mix-blend-mode: screen;
}

.barcode-box.glow::after{
  opacity:1;
  animation: scanSweep 520ms cubic-bezier(.2,.8,.2,1) forwards;
}

@keyframes scanSweep{
  0%   { transform: rotate(12deg) translateX(0); opacity:0; }
  15%  { opacity:1; }
  100% { transform: rotate(12deg) translateX(320%); opacity:0; }
}

/* 低減設定に配慮 */
@media (prefers-reduced-motion: reduce){
  .card::before, .sparkles, .barcode-box::after { display:none; }
  .barcode-box.glow{ animation:none; }
}


  </style>
</head>

<body>
  <div class="app">

    <!-- STEP1: 本人情報 -->
    <section class="box" id="step1">
      <h1>本人情報登録</h1>
      <p class="desc">現物カード発行時と同じ情報を入力してください（社内テスト）。</p>

      <label>氏名<input id="name"></label>
      <label>電話番号<input id="phone" inputmode="tel"></label>
      <label>生年月日<input id="dob" type="text" placeholder="1999/1/11"></label>
      <label>住所<input id="address"></label>

      <div class="error" id="err1"></div>

      <div class="actions">
        <button class="primary" id="toStep2">次へ</button>
      </div>
    </section>

    <!-- STEP2: カード番号 -->
    <section class="box" id="step2" style="display:none;">
      <h1>カードログイン</h1>
      <p class="desc">カード番号16桁（数字のみ）を入力してください。</p>

      <label>カード番号<input id="cardno" inputmode="numeric" maxlength="16"></label>

      <div class="error" id="err2"></div>

      <div class="actions">
        <button class="ghost" id="backTo1">戻る</button>
        <button class="primary" id="login">カード表示へ</button>
      </div>
    </section>

    <!-- STEP3: カード表示 -->
    <section class="box" id="step3" style="display:none;">
      <h1>やましろやPay</h1>
      <p class="desc">タップで表/裏を切り替え</p>

      <div class="wrap">
        <div class="card-container">
          <div class="card" id="card">
            <div class="sparkles" aria-hidden="true">
  <i style="--x0:20%; --y0:30%; --x1:5%;  --y1:10%;"></i>
  <i style="--x0:30%; --y0:65%; --x1:15%; --y1:90%;"></i>
  <i style="--x0:45%; --y0:40%; --x1:45%; --y1:5%;"></i>
  <i style="--x0:55%; --y0:70%; --x1:70%; --y1:95%;"></i>
  <i style="--x0:65%; --y0:35%; --x1:90%; --y1:15%;"></i>
  <i style="--x0:75%; --y0:55%; --x1:95%; --y1:60%;"></i>
  <i style="--x0:40%; --y0:55%; --x1:20%; --y1:35%;"></i>
  <i style="--x0:60%; --y0:45%; --x1:80%; --y1:30%;"></i>
  <i style="--x0:25%; --y0:45%; --x1:10%; --y1:55%;"></i>
  <i style="--x0:80%; --y0:40%; --x1:98%; --y1:35%;"></i>
  <i style="--x0:50%; --y0:25%; --x1:55%; --y1:0%;"></i>
  <i style="--x0:50%; --y0:80%; --x1:55%; --y1:110%;"></i>
</div>

            <div class="face front"></div>
            <div class="face back">
              <div class="barcode-box">
                <svg id="barcode"></svg>
                <div class="cardno" id="cardnoText"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="hint">カードをタップで反転</div>

        <div class="actions" style="width:100%;max-width:340px;">
          <button class="ghost" id="reset">登録情報をリセット</button>
        </div>
      </div>
    </section>

  </div>

  <!-- Code128生成ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <script>
    const KEY = "yamashiroyaPay_clean_v1";
    const $ = (id) => document.getElementById(id);

    function show(stepId){
      $("step1").style.display = "none";
      $("step2").style.display = "none";
      $("step3").style.display = "none";
      $(stepId).style.display = "block";
      window.scrollTo(0,0);
    }

    function digits(s){ return (s || "").replace(/\D/g,""); }
function fmt16(s){ return s.replace(/(\d{4})(?=\d)/g,"$1 ").trim(); }

    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : null;
      }catch{
        return null;
      }
    }
    function save(o){ localStorage.setItem(KEY, JSON.stringify(o)); }

    function setErr(id, msg){
      const el = $(id);
      if(!msg){
        el.style.display = "none";
        el.textContent = "";
        return;
      }
      el.textContent = msg;
      el.style.display = "block";
    }

    function drawBarcode(num){
  if (typeof JsBarcode === "undefined") {
    alert("バーコード生成ライブラリが読み込めませんでした。通信環境を確認して再読み込みしてください。");
    return;
  }

  const svg = $("barcode");
  svg.innerHTML = ""; // 残像対策

  JsBarcode(svg, num, {
    format:"CODE128",
    displayValue:false,
    height:50,
    margin:0,
    width:1.6
  });

  $("cardnoText").textContent = fmt16(num);

  // ★バーコード枠を光らせる（描画直後）
  const box = document.querySelector(".barcode-box");
  if (box){
    box.classList.remove("glow");
    void box.offsetWidth; // reflow
    box.classList.add("glow");
    setTimeout(() => box.classList.remove("glow"), 600);
  }
}

  // ===== 起動時（自動ログイン＋ちょい演出）=====
const data = load();
if (data && digits(data.cardno).length === 16){
  show("step3");                 // 先に画面だけ出す
  setTimeout(() => {             // ちょい待ってから描画
    drawBarcode(digits(data.cardno));
  }, 200);
} else {
  show("step1");
}


    // ===== STEP1 -> STEP2 =====
    $("toStep2").addEventListener("click", () => {
      setErr("err1", "");

      const name = $("name").value.trim();
      const phone = digits($("phone").value);
      const dob = $("dob").value.trim();
      const address = $("address").value.trim();

      if(!name || !phone || !dob || !address){
        setErr("err1", "すべて入力してください。");
        return;
      }
      if(phone.length < 10 || phone.length > 11){
        setErr("err1", "電話番号は10〜11桁で入力してください。");
        return;
      }

      const d = load() || {};
      d.name = name;
      d.phone = phone;
      d.dob = dob;
      d.address = address;
      save(d);

      show("step2");
    });

    // ===== STEP2 戻る =====
    $("backTo1").addEventListener("click", () => show("step1"));

    // ===== STEP2 -> STEP3 =====
    $("login").addEventListener("click", () => {
      setErr("err2", "");

      const c = digits($("cardno").value);
      if(c.length !== 16){
        setErr("err2", "カード番号は16桁（数字のみ）で入力してください。");
        return;
      }

      const d = load() || {};
      d.cardno = c;
      save(d);

      drawBarcode(c);
      show("step3");
    });

    // ===== カード反転 =====
$("card").addEventListener("click", () => {
  const card = $("card");

  // 連打対策（派手演出）
  card.classList.remove("flash", "sparkle", "sweep", "is-flipping", "is-press");

  // 押した感
  card.classList.add("is-press");

  // 光スイープ＆影
  card.classList.add("sweep", "is-flipping");

  // キラキラ＋フラッシュ
  card.classList.add("flash", "sparkle");

  // 反転
  card.classList.toggle("is-flipped");

  // 後片付け
  setTimeout(() => card.classList.remove("is-press"), 120);
  setTimeout(() => card.classList.remove("is-flipping"), 350);
  setTimeout(() => card.classList.remove("flash"), 420);
  setTimeout(() => card.classList.remove("sparkle"), 700);
  setTimeout(() => card.classList.remove("sweep"), 700);
});


    // ===== リセット =====
    $("reset").addEventListener("click", () => {
      if(confirm("登録情報をリセットしますか？")){
        localStorage.removeItem(KEY);
        location.reload();
      }
    });
  </script>
</body>
</html>
